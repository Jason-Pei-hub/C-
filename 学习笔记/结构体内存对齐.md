# 结构体内存对齐

我们已经掌握了结构体的基本使用了。 

现在我们深入讨论一个问题：计算结构体的大小。

 这也是一个特别热门的考点：

### 结构体内存对齐

```c
struct S1
{
 char c1;
 int i;
 char c2;
};
printf("%d\n", sizeof(struct S1));
//练习2
struct S2
{
 char c1;
 char c2;
 int i;
};
printf("%d\n", sizeof(struct S2));
//练习3
struct S3
{
 double d;
 char c;
 int i;
};
printf("%d\n", sizeof(struct S3));
//练习4-结构体嵌套问题
struct S4
{
 char c1;
 struct S3 s3;
 double d;
};
printf("%d\n", sizeof(struct S4));
```

### 如何计算？

**首先得掌握结构体的对齐规则：**

> 1. 第一个成员在与结构体变量偏移量为0的地址处。
>
> 2. 其他成员变量要对齐到某个数字（对齐数）的整数倍的地址处。
>
>     **对齐数** = 编译器默认的一个对齐数 与 该成员大小的较小值。
>
>    * VS中默认的值为8 
>
> 3. 结构体总大小为最大对齐数（每个成员变量都有一个对齐数）的整数倍。
>
> 4. 如果嵌套了结构体的情况，嵌套的结构体对齐到自己的最大对齐数的整数倍处，结构体的整 体大小就是所有最大对齐数（含嵌套结构体的对齐数）的整数倍。

**为什么存在内存对齐?**

1.  **平台原因(移植原因)：** 

   不是所有的硬件平台都能访问任意地址上的任意数据的；某些硬件平台只能在某些地址处取某些特 定类型的数据，否则抛出硬件异常。

2. **性能原因：** 

   数据结构(尤其是栈)应该尽可能地在自然边界上对齐。 原因在于，为了访问未对齐的内存，处理器需要作两次内存访问；而对齐的内存访问仅需要一次访 问。

总体来说：

> 结构体的内存对齐是拿**空间**来换取**时间**的做法。



那在设计结构体的时候，我们既要满足对齐，又要节省空间，如何做到：

> 让占用空间小的成员尽量集中在一起。

```c
//例如：
struct S1
{
 	char c1;
 	int i;
 	char c2;
};
struct S2
{
 	char c1;
 	char c2;
 	int i;
};
```

S1和S2类型的成员一模一样，但是S1和S2所占空间的大小有了一些区别。

## 修改默认对齐数

之前我们见过了 `#pragma` 这个预处理指令，这里我们再次使用，可以改变我们的默认对齐数。

```c
#include <stdio.h>
#pragma pack(8)//设置默认对齐数为8
struct S1
{
 char c1;
 int i;
 char c2;
};
#pragma pack()//取消设置的默认对齐数，还原为默认
#pragma pack(1)//设置默认对齐数为1
struct S2
{
 char c1;
 int i;
 char c2;
};
#pragma pack()//取消设置的默认对齐数，还原为默认
int main()
{
    //输出的结果是什么？
    printf("%d\n", sizeof(struct S1));
    printf("%d\n", sizeof(struct S2));
    return 0;
}
```

**结论：**

> 结构在对齐方式不合适的时候，我么可以自己更改默认对齐数。

---

## 结构体传参

```c
struct S
{
 	int data[1000];
 	int num;
};
struct S s = {{1,2,3,4}, 1000};
//结构体传参
void print1(struct S s)
{
 	printf("%d\n", s.num);
}
//结构体地址传参
void print2(struct S* ps)
{
	 printf("%d\n", ps->num);
}
int main()
{
	 print1(s);  //传结构体
	 print2(&s); //传地址
 	 return 0;
}
```

上面的 `print1` 和 `print2` 函数哪个好些？ 

答案是：首选`print2`函数。

> 函数传参的时候，参数是需要压栈，会有时间和空间上的系统开销。 
>
> 如果传递一个结构体对象的时候，结构体过大，参数压栈的的系统开销比较大，所以会导致性能的 下降。

**结论：**

结构体传参的时候，要传结构体的地址。